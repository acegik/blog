<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>TRANSACT-SQL: Ví Dụ MINH HọA Về PIVOT Và UNPIVOT &vert; ACEGIK'S BLOG</title>
<meta name="description" content="... when the sun comes up, you better be running!">
<meta name="keywords" content="SQLServer, Transact-SQL">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="/blog/images/logo.png">
<meta name="twitter:title" content="Transact-SQL: Ví dụ minh họa về PIVOT và UNPIVOT">
<meta name="twitter:description" content="... when the sun comes up, you better be running!">
<meta name="twitter:creator" content="@pnhung177">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Transact-SQL: Ví dụ minh họa về PIVOT và UNPIVOT">
<meta property="og:description" content="... when the sun comes up, you better be running!">
<meta property="og:url" content="/blog/rdbms/sqlserver/transact-sql-vi-du-minh-hoa-pivot-va-unpivot.html">
<meta property="og:site_name" content="Acegik's Blog">
<meta property="og:image" content="/blog/images/">





<link rel="canonical" href="/blog/rdbms/sqlserver/transact-sql-vi-du-minh-hoa-pivot-va-unpivot.html">
<link href="/blog/feed.xml" type="application/atom+xml" rel="alternate" title="Acegik's Blog Feed">
<link rel="author" href="https://plus.google.com/u/3/115458186421626071505?rel=author">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

<link href='http://fonts.googleapis.com/css?family=Montserrat:400,700|Open+Sans:400,600,300,800,700' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="/blog/assets/css/font-awesome.min.css">
<link rel="stylesheet" href="/blog/assets/css/vendor/normalize.css">
<link rel="stylesheet" href="/blog/assets/css/vendor/foundation.min.css">
<link rel="stylesheet" href="/blog/assets/css/style.css">
<link rel="stylesheet" href="/blog/assets/css/post.css">
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/blog/assets/js/vendor/jquery-1.11.1.min.js"><\/script>')</script>





<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/blog/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/blog/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/blog/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/blog/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/blog/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/blog/images/apple-touch-icon-144x144-precomposed.png">

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Acegik - sidebar -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2558234225933836"
     data-ad-slot="3073080904"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

</head>
<body class="post-template" itemscope itemtype="http://schema.org/WebPage">


        <main id="cheryk-post-container-simple" class="cheryk-post-container-simple" role="main">
            <header class="cheryk-post-header-simple">
                <div class="cheryk-post-menu-header-simple">

                    <a class="cheryk-blog-logo" href="/blog">
                        <img src="/blog/images/logo.png" alt="Blog Logo" />
                    </a>

                <div class="cheryk-blog-menu">      
    <div class="cheryk-mobile-menu show-for-small">
        <a href="#"><i class="fa fa-bars"></i></a>
    </div>
    <ul class="cheryk-menu">
        <li class="cheryk-mobile-close-btn show-for-small text-right">
            <a href="#"><i class="fa fa-times"></i></a>
        </li>

            <li>
                    <a href="/blog/">Trang bìa</a>
                 </li>

            <li>
                    <a href="/blog/featured">Danh sách</a>
                 </li>

            <li>
                    <a href="/blog/categories">Phân loại</a>
                 </li>

            <li>
                    <a href="/blog/about">Giới thiệu</a>
                 </li>
            
           <li><a href="/blog/feed.xml" title="Atom/RSS feed"><i class="icon-rss"></i> Feed</a></li>
    </ul>

</div>
            </div>

                <div class="cheryk-post-title-simple row">
                    <div class="small-12 columns">
                        <div class="cheryk-post-meta-simple">
                            <h1>Transact-SQL: Ví dụ minh họa về PIVOT và UNPIVOT</h1>
                            <p>by <strong>pnhung177</strong> &#8212; on <a href="/blog/tags/index.html#SQLServer" data-toggle="tooltip" title="Posts tagged with SQLServer" rel="tag">SQLServer</a>&nbsp;&comma;&nbsp;<a href="/blog/tags/index.html#Transact-SQL" data-toggle="tooltip" title="Posts tagged with Transact-SQL" rel="tag">Transact-SQL</a> &#8212; <strong><time datetime="2008-07-18T00:00:00+07:00">18/07/2008</time></strong></p>
                        </div>
                    </div>
                </div>
            </header>

        <article class="cheryk-post-content post tag-simple">
            <div><p><em>PIVOT</em>, trong các hệ quản trị cơ sở dữ liệu, là lệnh tổng hợp dữ liệu cho phép chuyển dữ liệu trong một cột của một Table thành các trường dữ liệu của một Table khác. Lệnh này cho phép người dùng có thể chọn một trường dữ liệu làm tiêu chí, từ đó “chiếu” các dữ liệu khác lên trường dữ liệu này để quan sát. </p>

<h2 id="pivot">PIVOT</h2>

<p>Để minh hoạ cho lệnh PIVOT, ta tạo một bảng dữ liệu về đơn đặt hàng của một cửa hàng bán đồ điện tử (Laptop, điện thoại di động, .v.v.).</p>

<p>Đầu tiên, chuyển vào làm việc trong CSDL tempdb, sau đó tạo bảng Sales_Order và chèn dữ liệu minh họa vào bảng:</p>

<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">use</span> <span class="n">tempdb</span><span class="p">;</span>

<span class="n">if</span> <span class="k">exists</span> <span class="p">(</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">sysobjects</span> <span class="k">where</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Sales_Order&#39;</span> <span class="k">and</span> <span class="k">type</span><span class="o">=</span><span class="s1">&#39;U&#39;</span><span class="p">)</span>
<span class="k">drop</span> <span class="k">table</span> <span class="n">Sales_Order</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">Sales_Order</span>
<span class="p">(</span>
	<span class="n">Customer</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> 
	<span class="n">Product</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> 
	<span class="n">Quantity</span> <span class="nb">int</span>
<span class="p">);</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">Sales_Order</span> <span class="k">values</span> <span class="p">(</span><span class="s1">&#39;Minh Thu&#39;</span><span class="p">,</span>  	 <span class="s1">&#39;Laptop&#39;</span><span class="p">,</span>  	<span class="mi">3</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">Sales_Order</span> <span class="k">values</span> <span class="p">(</span><span class="s1">&#39;Minh Thu&#39;</span><span class="p">,</span>  	 <span class="s1">&#39;iPhone&#39;</span><span class="p">,</span>  	<span class="mi">2</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">Sales_Order</span> <span class="k">values</span> <span class="p">(</span><span class="s1">&#39;Minh Thu&#39;</span><span class="p">,</span>  	 <span class="s1">&#39;Laptop&#39;</span><span class="p">,</span>  	<span class="mi">5</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">Sales_Order</span> <span class="k">values</span> <span class="p">(</span><span class="s1">&#39;Tuan Anh&#39;</span><span class="p">,</span>  	 <span class="s1">&#39;Laptop&#39;</span><span class="p">,</span>  	<span class="mi">3</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">Sales_Order</span> <span class="k">values</span> <span class="p">(</span><span class="s1">&#39;Tuan Anh&#39;</span><span class="p">,</span>  	 <span class="s1">&#39;iPhone&#39;</span><span class="p">,</span>  	<span class="mi">3</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">Sales_Order</span> <span class="k">values</span> <span class="p">(</span><span class="s1">&#39;Tuan Anh&#39;</span><span class="p">,</span>  	 <span class="s1">&#39;iPhone&#39;</span><span class="p">,</span>  	<span class="mi">4</span><span class="p">);</span></code></pre></div>

<p>Thực hiện lệnh Select để xem dữ liệu đã chèn đúng chưa?</p>

<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">Sales_Order</span><span class="p">;</span></code></pre></div>

<p>Kết quả lệnh Select có dạng như sau:</p>

<p><img src="/blog/media/0aa0955c-4f80-4e69-ad84-049e997391a1/pivot-sample-data-select-output.png" alt="Bảng dữ liệu minh họa" /></p>

<p>Sau khi đã có đầy đủ dữ liệu rồi, ta thực hiện việc thống kê thông tin về tổng số hàng mà mỗi khách hàng đặt mua cho mỗi loại hàng. Sử dụng lệnh PIVOT áp dụng cho cột Product và tính tổng cột Quantity, ta được:</p>

<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">Sales_Order</span>
<span class="n">PIVOT</span> <span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">Quantity</span><span class="p">)</span> <span class="k">FOR</span> <span class="n">Product</span> <span class="k">IN</span> <span class="p">([</span><span class="n">Laptop</span><span class="p">],[</span><span class="n">iPhone</span><span class="p">]))</span> <span class="k">AS</span> <span class="n">PivotedOrder</span><span class="p">;</span></code></pre></div>

<p>Thực thi câu lệnh SQL này, ta được:</p>

<p><img src="/blog/media/0aa0955c-4f80-4e69-ad84-049e997391a1/pivot-sample-data-select-pivot-result.png" alt="Kết quả thực thi Select với Pivot" /></p>

<p>Lưu ý, ta có thể Select tiếp từ kết quả của PIVOT trên như sau:</p>

<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="n">Customer</span><span class="p">,</span> <span class="p">[</span><span class="n">Laptop</span><span class="p">]</span> <span class="k">FROM</span> 
<span class="p">(</span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">Sales_Order</span><span class="p">)</span> <span class="k">AS</span> <span class="n">OriginalOrder</span>
<span class="n">PIVOT</span> <span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">Quantity</span><span class="p">)</span> <span class="k">FOR</span> <span class="n">Product</span> <span class="k">IN</span> <span class="p">([</span><span class="n">Laptop</span><span class="p">],[</span><span class="n">iPhone</span><span class="p">]))</span> <span class="k">AS</span> <span class="n">PivotedOrder</span><span class="p">;</span></code></pre></div>

<p>Khi đó, kết quả sẽ co hẹp lại:</p>

<p><img src="/blog/media/0aa0955c-4f80-4e69-ad84-049e997391a1/pivot-sample-data-select-pivot-select-result.png" alt="Kết quả sẽ co hẹp lại" /></p>

<h2 id="unpivot">UNPIVOT</h2>

<p>Lệnh UNPIVOT có chức năng ngược lại với chức năng của lệnh PIVOT. Xét ví dụ sau:</p>

<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">if</span> <span class="k">exists</span> <span class="p">(</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">sysobjects</span> 
		<span class="k">where</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Sales_PivotedOrder&#39;</span> <span class="k">and</span> <span class="k">type</span><span class="o">=</span><span class="s1">&#39;U&#39;</span><span class="p">)</span>
<span class="k">drop</span> <span class="k">table</span> <span class="n">Sales_PivotedOrder</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">Sales_PivotedOrder</span>
<span class="p">(</span>
	<span class="n">Customer</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> 
	<span class="n">Laptop</span> <span class="nb">int</span><span class="p">,</span> 
	<span class="n">iPhone</span> <span class="nb">int</span>
<span class="p">);</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">Sales_PivotedOrder</span> <span class="k">values</span> <span class="p">(</span><span class="s1">&#39;Minh Thu&#39;</span><span class="p">,</span>  	 <span class="mi">8</span><span class="p">,</span>  	<span class="mi">2</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">Sales_PivotedOrder</span> <span class="k">values</span> <span class="p">(</span><span class="s1">&#39;Tuan Anh&#39;</span><span class="p">,</span>  	 <span class="mi">3</span><span class="p">,</span>  	<span class="mi">7</span><span class="p">);</span>

<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">Sales_PivotedOrder</span><span class="p">;</span></code></pre></div>

<p>Thực thi các lệnh trên, ta được bảng có dạng sau:</p>

<p><img src="/blog/media/0aa0955c-4f80-4e69-ad84-049e997391a1/unpivot-sample-data-try-select-result.png" alt="Bảng dữ liệu minh họa ví dụ Select - Unpivot" /></p>

<p>Thực thi lệnh UNPIVOT trên bảng Sales_PivotedOrder trên:</p>

<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="n">Customer</span><span class="p">,</span> <span class="n">Product</span><span class="p">,</span> <span class="n">Quantity</span> <span class="k">FROM</span> <span class="n">Sales_PivotedOrder</span>
<span class="n">UNPIVOT</span> <span class="p">(</span><span class="n">Quantity</span> <span class="k">FOR</span> <span class="n">Product</span> <span class="k">IN</span> <span class="p">([</span><span class="n">Laptop</span><span class="p">],[</span><span class="n">iPhone</span><span class="p">]))</span> <span class="k">AS</span> <span class="n">UnPVT</span><span class="p">;</span></code></pre></div>

<p>Ta thu được kết quả:</p>

<p><img src="/blog/media/0aa0955c-4f80-4e69-ad84-049e997391a1/unpivot-sample-data-select-unpivot-result.png" alt="Kết quả thực thi lệnh Select - Unpivot" /></p>

<p>Các bạn có thể tải <a href="/blog/media/0aa0955c-4f80-4e69-ad84-049e997391a1/pivot-unpivot-example.zip">mã nguồn</a> của ví dụ minh họa trên để thử nghiệm.</p>

            </div>
        </article>

        <div class="cf"></div>
        <div class="row text-center">
            <section class="cheryk-post-share">
                <a class="twitter-icon" href="https://twitter.com/intent/tweet?text=&quot;Transact-SQL: Ví dụ minh họa về PIVOT và UNPIVOT&quot;%20/blog/rdbms/sqlserver/transact-sql-vi-du-minh-hoa-pivot-va-unpivot.html%20via%20&#64;pnhung177"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title="Share on Twitter">
                    <i class="fa fa-twitter"></i>
                </a>
                <a class="facebook-icon" href="https://www.facebook.com/sharer/sharer.php?u=/blog/rdbms/sqlserver/transact-sql-vi-du-minh-hoa-pivot-va-unpivot.html"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title="Share on Facebook">
                    <i class="fa fa-facebook"></i>
                </a>
                <a class="google-icon" href="https://plus.google.com/share?url=/blog/rdbms/sqlserver/transact-sql-vi-du-minh-hoa-pivot-va-unpivot.html"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;" title="Share on Google+">
                    <i class="fa fa-google-plus"></i>
                </a>
            </section>
        </div>
        <div class="cf"></div>
            <div class="cheryk-author-info">
                <div class="row">
                    <section class="cheryk-post-author small-12 columns">
                        
                            <img src="/blog/images/avatars/pnhung177.png" class="cheryk-post-author-avatar" alt="Phạm Ngọc Hùng's photo">
                        
                            <span class="author-label">Author</span>
                            <h1>Phạm Ngọc Hùng</h1>
                        
                            <p><a href="mailto:pnhung177@drupalex.net" class="author-website">pnhung177@drupalex.net</a></p>
                        
                            <p>... when the sun comes up, you better be running!</p>
                        
                    </section>
                </div>
            </div> 
        <div class="cf"></div>

        
        <section class="cheryk-disqus row">
    <div class="small-12 columns">
        <h1 class="cheryk-comments-header">Comments</h1>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'acegik'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
</section>

         
</main> 


<div class="cf"></div>
<footer class="cheryk-site-footer">
    <div class="copyright">
         <section>Bản quyền nội dung thuộc về <a href="/blog/about">Phạm Ngọc Hùng</a> &copy; 2015.</section>
    </div>
    <div class="social-icons">
        
        
        <a href="http://twitter.com/pnhung177">
            <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x fa-inverse"></i>
                <i class="fa fa-twitter fa-stack-1x"></i>
            </span>
        </a>
        
        
        <a href="https://plus.google.com/u/3/115458186421626071505">
            <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x fa-inverse"></i>
                <i class="fa fa-google-plus fa-stack-1x"></i>
            </span>
        </a>
        
        
        <a href="http://github.com/pnhung177">
            <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x fa-inverse"></i>
                <i class="fa fa-github fa-stack-1x"></i>
            </span>
        </a>
        
        
        <a href="http://facebook.com/pnhung177">
            <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x fa-inverse"></i>
                <i class="fa fa-facebook fa-stack-1x"></i>
            </span>
        </a>
        
    </div>
    
    <div class="cf"></div>
</footer>

<script src="/blog/assets/js/vendor/modernizr.js"></script>
<script src="/blog/assets/js/foundation.min.js"></script>
<script src="/blog/assets/js/vendor/background-check.js"></script>
<script src="/blog/assets/js/vendor/post-header-animations.js"></script>
<script src="/blog/assets/js/main.js"></script>

<script>
  $(document).foundation();
</script>



<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-54128248-1', 'auto');
  ga('require', 'displayfeatures');
  ga('send', 'pageview');

</script>


  
</body>
</html>
