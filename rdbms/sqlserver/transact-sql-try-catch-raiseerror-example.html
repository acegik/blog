<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>TRANSACT-SQL: Xử Lý LỗI VớI TRY - CATCH - RAISEERROR &vert; ACEGIK'S BLOG</title>
<meta name="description" content="... when the sun comes up, you better be running!">
<meta name="keywords" content="SQLServer, Transact-SQL, Error Handling">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="/blog/images/logo.png">
<meta name="twitter:title" content="Transact-SQL: Xử lý lỗi với TRY - CATCH - RAISEERROR">
<meta name="twitter:description" content="... when the sun comes up, you better be running!">
<meta name="twitter:creator" content="@pnhung177">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Transact-SQL: Xử lý lỗi với TRY - CATCH - RAISEERROR">
<meta property="og:description" content="... when the sun comes up, you better be running!">
<meta property="og:url" content="/blog/rdbms/sqlserver/transact-sql-try-catch-raiseerror-example.html">
<meta property="og:site_name" content="Acegik's Blog">
<meta property="og:image" content="/blog/images/">





<link rel="canonical" href="/blog/rdbms/sqlserver/transact-sql-try-catch-raiseerror-example.html">
<link href="/blog/feed.xml" type="application/atom+xml" rel="alternate" title="Acegik's Blog Feed">
<link rel="author" href="https://plus.google.com/u/3/115458186421626071505?rel=author">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

<link href='http://fonts.googleapis.com/css?family=Montserrat:400,700|Open+Sans:400,600,300,800,700' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="/blog/assets/css/font-awesome.min.css">
<link rel="stylesheet" href="/blog/assets/css/vendor/normalize.css">
<link rel="stylesheet" href="/blog/assets/css/vendor/foundation.min.css">
<link rel="stylesheet" href="/blog/assets/css/style.css">
<link rel="stylesheet" href="/blog/assets/css/post.css">
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/blog/assets/js/vendor/jquery-1.11.1.min.js"><\/script>')</script>





<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/blog/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/blog/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/blog/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/blog/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/blog/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/blog/images/apple-touch-icon-144x144-precomposed.png">

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Acegik - sidebar -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2558234225933836"
     data-ad-slot="3073080904"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

</head>
<body class="post-template" itemscope itemtype="http://schema.org/WebPage">


        <main id="cheryk-post-container-simple" class="cheryk-post-container-simple" role="main">
            <header class="cheryk-post-header-simple">
                <div class="cheryk-post-menu-header-simple">

                    <a class="cheryk-blog-logo" href="/blog">
                        <img src="/blog/images/logo.png" alt="Blog Logo" />
                    </a>

                <div class="cheryk-blog-menu">      
    <div class="cheryk-mobile-menu show-for-small">
        <a href="#"><i class="fa fa-bars"></i></a>
    </div>
    <ul class="cheryk-menu">
        <li class="cheryk-mobile-close-btn show-for-small text-right">
            <a href="#"><i class="fa fa-times"></i></a>
        </li>

            <li>
                    <a href="/blog/">Trang bìa</a>
                 </li>

            <li>
                    <a href="/blog/featured">Danh sách</a>
                 </li>

            <li>
                    <a href="/blog/categories">Phân loại</a>
                 </li>

            <li>
                    <a href="/blog/about">Giới thiệu</a>
                 </li>
            
           <li><a href="/blog/feed.xml" title="Atom/RSS feed"><i class="icon-rss"></i> Feed</a></li>
    </ul>

</div>
            </div>

                <div class="cheryk-post-title-simple row">
                    <div class="small-12 columns">
                        <div class="cheryk-post-meta-simple">
                            <h1>Transact-SQL: Xử lý lỗi với TRY - CATCH - RAISEERROR</h1>
                            <p>by <strong>pnhung177</strong> &#8212; on <a href="/blog/tags/index.html#SQLServer" data-toggle="tooltip" title="Posts tagged with SQLServer" rel="tag">SQLServer</a>&nbsp;&comma;&nbsp;<a href="/blog/tags/index.html#Transact-SQL" data-toggle="tooltip" title="Posts tagged with Transact-SQL" rel="tag">Transact-SQL</a>&nbsp;&comma;&nbsp;<a href="/blog/tags/index.html#Error Handling" data-toggle="tooltip" title="Posts tagged with Error Handling" rel="tag">Error Handling</a> &#8212; <strong><time datetime="2008-08-02T00:00:00+07:00">02/08/2008</time></strong></p>
                        </div>
                    </div>
                </div>
            </header>

        <article class="cheryk-post-content post tag-simple">
            <div><p>SQLServer Transact-SQL cung cấp cơ chế kiểm soát lỗi bằng TRY … CATCH như trong các ngôn ngữ lập trình phổ dụng hiện nay (Java, C, PHP). Bài viết này giới thiệu những vấn đề chung trong việc sử dụng <em>TRY … CATCH</em> cùng với hàm <em>RAISEERROR</em> để quản lý lỗi khi lập trình SQL trên SQL Server.</p>

<h2 id="v-d-n-gin-v-try--catch">Ví dụ đơn giản về TRY … CATCH</h2>

<p>Đầu tiên, ta xét một ví dụ phát sinh lỗi đơn giản sau:</p>

<p><img src="/blog/media/c91f9871-372e-445a-b16e-12f0210cea3d/begin-try-begin-catch-example.png" alt="Ví dụ về try ... catch ..." /></p>

<p>Sau khi thực thi câu lệnh, ta thu được kết quả:</p>

<p><img src="/blog/media/c91f9871-372e-445a-b16e-12f0210cea3d/begin-try-begin-catch-result.png" alt="Kết quả chạy try ... catch ..." /></p>

<h2 id="cc-hm-c-thng-tin-li">Các hàm đọc thông tin lỗi</h2>

<p>Dưới đây là một số hàm cung cấp thông tin về lỗi vừa phát sinh:</p>

<p><img src="/blog/media/c91f9871-372e-445a-b16e-12f0210cea3d/error-functions.png" alt="Các hàm xử lý lỗi" /></p>

<h2 id="s-dng-try--catch-vi-transaction">Sử dụng TRY … CATCH với TRANSACTION</h2>

<p>Ta có thể sử dụng kết hợp TRY … CATCH với khối TRANSACTION. Bên trong khối TRANSACTION, các lệnh thao tác với dữ liệu được đặt trong một khối TRY để khi có bất cứ lỗi nào xảy ra, chương trình có thể bắt được và xử lý.</p>

<p>Trước tiên, ta chuyển vào làm việc trong CSDL tempdb:</p>

<p><img src="/blog/media/c91f9871-372e-445a-b16e-12f0210cea3d/try-catch-with-transaction--db.png" alt="Tạo dữ liệu minh họa" /></p>

<p>Sau khi thực hiện các lệnh trên, ta có bảng dữ liệu kết quả như sau:</p>

<p><img src="/blog/media/c91f9871-372e-445a-b16e-12f0210cea3d/try-catch-with-transaction--result.png" alt="Tạo dữ liệu minh họa" /></p>

<p>Sử dụng TRANSACTION để cập nhật một loạt dữ liệu:</p>

<p><img src="/blog/media/c91f9871-372e-445a-b16e-12f0210cea3d/try-catch-with-transaction--insert-error.png" alt="Cập nhật dữ liệu trong một Transaction" /></p>

<p>Sau khi thực hiện xong, ta thử truy vấn lại bảng T1, kết quả truy vấn vẫn giống như trước khi thực hiện TRANSACTION (do TRANSACTION bị lỗi nên đã ROLLBACK toàn bộ):</p>

<p><img src="/blog/media/c91f9871-372e-445a-b16e-12f0210cea3d/try-catch-with-transaction--insert-error--result.png" alt="Cập nhật dữ liệu trong một Transaction" /></p>

<h2 id="s-dng-try--catch-vi-procedure">Sử dụng TRY … CATCH với PROCEDURE</h2>

<p>Trong ví dụ này, ta xây dựng Stored Procedure có sử dụng khối lệnh TRY … CATCH để bắt và xử lý lỗi. Xét 2 bảng A và B được tạo như sau:</p>

<p><img src="/blog/media/c91f9871-372e-445a-b16e-12f0210cea3d/try-catch-with-procedure--create-A-declare.png" alt="Tạo bảng A" /></p>

<p>Kết quả thực thi lệnh tạo bảng A:</p>

<p><img src="/blog/media/c91f9871-372e-445a-b16e-12f0210cea3d/try-catch-with-procedure--create-A-result.png" alt="Kết quả thực thi lệnh tạo bảng A" /></p>

<p>Lệnh tạo bảng B:</p>

<p><img src="/blog/media/c91f9871-372e-445a-b16e-12f0210cea3d/try-catch-with-procedure--create-B-declare.png" alt="Tạo bảng B" /></p>

<p>Kết quả thực thi lệnh tạo bảng B:</p>

<p><img src="/blog/media/c91f9871-372e-445a-b16e-12f0210cea3d/try-catch-with-procedure--create-B-result.png" alt="Kết quả thực thi lệnh tạo bảng B" /></p>

<p>Tạo STORED PROCEDURE xóa bản ghi trong A như sau:</p>

<p><img src="/blog/media/c91f9871-372e-445a-b16e-12f0210cea3d/try-catch-with-procedure--create-deleteA-procedure.png" alt="Tạo STORED PROCEDURE xóa bản ghi trong A" /></p>

<p>Sử dụng STORED PROCEDURE này để xóa một bản ghi của A:</p>

<p><img src="/blog/media/c91f9871-372e-445a-b16e-12f0210cea3d/try-catch-with-procedure--create-deleteA-execute.png" alt="Sử dụng STORED PROCEDURE" /></p>

<p>Thông báo lỗi như sau:</p>

<p><img src="/blog/media/c91f9871-372e-445a-b16e-12f0210cea3d/try-catch-with-procedure--create-deleteA-result.png" alt="Kết quả thực thi" /></p>

<p>Để có thể bắt và xử lý lỗi này ngay bên trong STORED PROCEDURE, ta cần sử dụng khối lệnh TRY … CATCH … Chỉnh sửa STORED PROCEDURE hiện tại để bổ sung TRY … CATCH:</p>

<p><img src="/blog/media/c91f9871-372e-445a-b16e-12f0210cea3d/try-catch-with-procedure--create-deleteA-try-catch--declare.png" alt="Bổ sung thêm TRY ... CATCH vào Procedure" /></p>

<p>Gọi Procedure và bắt lỗi nếu có:</p>

<p><img src="/blog/media/c91f9871-372e-445a-b16e-12f0210cea3d/try-catch-with-procedure--create-deleteA-try-catch--execute.png" alt="Gọi và bắt lỗi" /></p>

<p>Kết quả thực thi lệnh gọi thủ tục trên:</p>

<p><img src="/blog/media/c91f9871-372e-445a-b16e-12f0210cea3d/try-catch-with-procedure--create-deleteA-try-catch--result.png" alt="Kết quả thực thi" /></p>

<p>Muốn hiểu rõ giá trị các thông số Msg: 547, Level: 16, State: 0,… hãy đọc tiếp phần bài viết RAISEERROR ở bên dưới.</p>

<h2 id="s-dng-lnh-raiseerror--pht-sinh-li">Sử dụng lệnh RAISEERROR để phát sinh lỗi</h2>

<p>Xét bảng dữ liệu lưu danh sách sinh viên với dữ liệu mẫu như sau:</p>

<p><img src="/blog/media/c91f9871-372e-445a-b16e-12f0210cea3d/raiseerror--create-table.png" alt="Tạo bảng dữ liệu minh họa" /></p>

<p>Và một STORED PROCEDURE có tên insertStudent dùng để chèn thêm Student mới vào bảng:</p>

<p><img src="/blog/media/c91f9871-372e-445a-b16e-12f0210cea3d/raiseerror--insertStudent--declare.png" alt="Tạo Procedure chèn thông tin sinh viên" /></p>

<p>Khi chèn dữ liệu, ta nhận thấy rằng mã sinh viên (trường rollno) phải có đúng 7 ký tự, ngoài ra tên của sinh viên (trường fullname) không được để rỗng. Trong trường hợp người dùng nhập sai dữ liệu, ta cần phát sinh thông báo lỗi để người dùng biết và nhập lại dữ liệu đúng. Khi đó, ta sử dụng câu lệnh RAISE ERROR như sau:</p>

<p><img src="/blog/media/c91f9871-372e-445a-b16e-12f0210cea3d/raiseerror--insertStudent--declare-with-raiseerror.png" alt="Tạo Procedure có sử dụng RaiseError" /></p>

<p>Lưu ý là giá trị SEVERITY phải lớn hơn 10 thì lệnh TRY … CATCH bên dưới đây mới bắt được lỗi:</p>

<p><img src="/blog/media/c91f9871-372e-445a-b16e-12f0210cea3d/raiseerror--insertStudent--execute.png" alt="Thực thi Procedure" /></p>

<p>Khi đó, ta nhận được thông báo lỗi:</p>

<p><img src="/blog/media/c91f9871-372e-445a-b16e-12f0210cea3d/raiseerror--insertStudent--result.png" alt="Kết quả thực thi Procedure" /></p>

<p>Thông tin và cách sử dụng các thông số trong lời gọi RAISERROR tham khảo trong <a href="http://msdn.microsoft.com/en-us/library/ms178592.aspx">tài liệu MS SQLServer</a>.</p>


            </div>
        </article>

        <div class="cf"></div>
        <div class="row text-center">
            <section class="cheryk-post-share">
                <a class="twitter-icon" href="https://twitter.com/intent/tweet?text=&quot;Transact-SQL: Xử lý lỗi với TRY - CATCH - RAISEERROR&quot;%20/blog/rdbms/sqlserver/transact-sql-try-catch-raiseerror-example.html%20via%20&#64;pnhung177"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title="Share on Twitter">
                    <i class="fa fa-twitter"></i>
                </a>
                <a class="facebook-icon" href="https://www.facebook.com/sharer/sharer.php?u=/blog/rdbms/sqlserver/transact-sql-try-catch-raiseerror-example.html"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title="Share on Facebook">
                    <i class="fa fa-facebook"></i>
                </a>
                <a class="google-icon" href="https://plus.google.com/share?url=/blog/rdbms/sqlserver/transact-sql-try-catch-raiseerror-example.html"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;" title="Share on Google+">
                    <i class="fa fa-google-plus"></i>
                </a>
            </section>
        </div>
        <div class="cf"></div>
            <div class="cheryk-author-info">
                <div class="row">
                    <section class="cheryk-post-author small-12 columns">
                        
                            <img src="/blog/images/avatars/pnhung177.png" class="cheryk-post-author-avatar" alt="Phạm Ngọc Hùng's photo">
                        
                            <span class="author-label">Author</span>
                            <h1>Phạm Ngọc Hùng</h1>
                        
                            <p><a href="mailto:pnhung177@drupalex.net" class="author-website">pnhung177@drupalex.net</a></p>
                        
                            <p>... when the sun comes up, you better be running!</p>
                        
                    </section>
                </div>
            </div> 
        <div class="cf"></div>

        
        <section class="cheryk-disqus row">
    <div class="small-12 columns">
        <h1 class="cheryk-comments-header">Comments</h1>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'acegik'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
</section>

         
</main> 


<div class="cf"></div>
<footer class="cheryk-site-footer">
    <div class="copyright">
         <section>Bản quyền nội dung thuộc về <a href="/blog/about">Phạm Ngọc Hùng</a> &copy; 2015.</section>
    </div>
    <div class="social-icons">
        
        
        <a href="http://twitter.com/pnhung177">
            <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x fa-inverse"></i>
                <i class="fa fa-twitter fa-stack-1x"></i>
            </span>
        </a>
        
        
        <a href="https://plus.google.com/u/3/115458186421626071505">
            <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x fa-inverse"></i>
                <i class="fa fa-google-plus fa-stack-1x"></i>
            </span>
        </a>
        
        
        <a href="http://github.com/pnhung177">
            <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x fa-inverse"></i>
                <i class="fa fa-github fa-stack-1x"></i>
            </span>
        </a>
        
        
        <a href="http://facebook.com/pnhung177">
            <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x fa-inverse"></i>
                <i class="fa fa-facebook fa-stack-1x"></i>
            </span>
        </a>
        
    </div>
    
    <div class="cf"></div>
</footer>

<script src="/blog/assets/js/vendor/modernizr.js"></script>
<script src="/blog/assets/js/foundation.min.js"></script>
<script src="/blog/assets/js/vendor/background-check.js"></script>
<script src="/blog/assets/js/vendor/post-header-animations.js"></script>
<script src="/blog/assets/js/main.js"></script>

<script>
  $(document).foundation();
</script>



<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-54128248-1', 'auto');
  ga('require', 'displayfeatures');
  ga('send', 'pageview');

</script>


  
</body>
</html>
